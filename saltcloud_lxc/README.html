<h2>Salt Cloud can now spawn LXC Containers, or how SaltStack made lxc containers managment easy</h2>

<h3>Introduction</h3>
<p>I just added some great things to SaltStack for lxc managment<br/>
Indeed we all want docker but we also have some legacy application and transition phases, and even deadlines preventing us to do what would be the best.<br>
So idea ? Use lxc containers in transition.
But, at this time, LXC support was not that much complete  with SaltStack so i decided to integrate it with salt-cloud.<br>
My idea behind the wall is to make our provisions with the same interface: cloud ones, lxc ones but also baremetal ones and here salt-cloud is the perfect tool.<br/>
</p>
<p>
<ul>This one will at least:
  <li>Create the "node" if applicable</li>
  <li>Base configure it</li>
  <li>Bootstrap it</li>
  <li>Link the provionned new vm/container to the up level master as a minion</li>
</ul>
</p>

<p>
And depending on the driver, you can do much more via <b>"actions"</b>.
One of those actions is trivially the "destroy" command.<br>
</p>

<h3>Presentation</h3>
<p>
So now, how to install an LXC Container via salt-cloud ?
The more tedious part is in configurating your base profiles and understanding the interaction between all salt pieces.
</p>

<b>The driver has 2 provision modes</b>
<ul>
<li><b>Creating</b> (using lxc-create) a LXC container from a template</li>
<li><b>Cloning</b> (using lxc-clone) a LXC container from an existing container</li>
</ul>

<pre>
SALT CLOUD cli or state >
  profile / vmoptions >
    salt-cloud provider >
      distant/local minion >
        execution module for LXC managment
</pre>
<ul>To summarise:
<li>We need a salt minion which will be the 'LXC host' for the containers</li>
<li>That host must be running a <b>decent LXC version ( > 1.0 )</b></li>
<li>We need at least one salt-cloud provider that indicates which minion to install LXC containers onto</li>
<li>We need a salt cloud profile defining the containers properties.</li>
<li>This profile will be linked to the provider</li>
<li>We can then create a salt cloud vm !</li>
</ul>

<h3>Practising</h3>
<p>First thing is to create a provider, and we indicate on which minion we want to operate the creation of LXC containers<br>
<b>/etc/salt/cloud.providers.d/lxc.conf</b>
<pre>
devhost10-local-lxc:
  target: devhost10.local
  provider: lxc
</pre> </p>
<p>The second thing is that we will need a profile to provision our vms not to repeat each option at any time</p>
<b>/etc/salt/cloud.profiles.d/lcx.conf</b>
<pre>
fancy-lxc:
  # the provider to use
  provider: devhost10-local-lxc
  # lxc options, read the LXC driver documentation and ... code :)
  image: ubuntu
  size: 3g
  bridge: lxcbr0
  gateway: 10.0.3.1
  mac: 00:16:3e:14:e7:e0
  backing: lvm
  vgname: lxc
  sudo: True
  ssh_username: ubuntu
  password: foobar
  # The master where we will link this new vm
  minion:
    # where will be your master located on the lxc point of view
    master: 10.0.3.1
    master_port: 4506
</pre>
<p>
Now it's time to create a box, you will need it's name, mac (generate a random but unique one) and ip.
My personal way of using salt cloud is via states, so just create a sls:<br/>
<b>/srv/salt/cloud.sls:</b>
<pre>
myfancylxc:
  cloud.profile:
    - profile: fancy-lxc
    - mac: 00:16:3e:14:e7:e0
    - ip: 10.0.3.54
</pre>
And run it with
<pre>salt-call state.sls cloud</pre>
</p>
<p>And after a while, after the sucessfulness of the last command, you can ping your new minion which is a lxc container:<br>
<pre>
local:
----------
          ID: myfancylxc
    Function: cloud.profile
      Result: True
     Comment: Minion is alive for salt commands
     Changes:
              ----------
              100_creation:
                  Container created

              150_conf:
                  lxc conf ok
              200_start:
                  started
              250_password:
                  Password updated
              300_ipattrib:
                  Got ip 10.0.3.54
              350_dns:
                  DNS updated
              400_salt:
                  This vm is now a salt minion
              401_salt:
                  Minion is alive for salt commands

Summary
------------
Succeeded: 1
Failed:    0
------------
Total:     1

</pre>
<b>salt myfancylxc test.ping</b>
<pre>
myfancylxc:
  True
</pre>
</p>

<p>We can even make a profile to use our previous vm as a base for other containers<br/>
Take a look to the <b>from_container</b> attribute.
<b>/etc/salt/cloud.profiles.d/lcx2.conf</b>
<pre>
snapshoted-lxc:
  from_container: myfancylxc
  backing: lvm
  bridge: lxcbr0
  gateway: 10.0.3.1
  mac: 00:16:3e:14:e7:e1
  sudo: True
  vgname: lxc
  ssh_username: ubuntu
  password: foobar
  minion:
    master: 10.0.3.1
    master_port: 4506
</pre>
<b>/srv/salt/cloud2.sls:</b>
<pre>
myfancylxc2:
  cloud.profile:
    - profile: snapshoted-lxc
    - mac: 00:16:3e:14:e7:e1
    - ip: 10.0.3.56
<pre>
and run it with
<pre>salt-call state.sls cloud2</pre>
</p>
<p>And after a while, after the sucessfulness of the last command, you can ping your new minion which is a lxc container:<br>
<b>salt myfancylxc test.ping</b>
<pre>
myfancylxc2:
  True
</pre> </p>
<p>Want a complex example for running away ?
See an example <a href="https://github.com/makinacorpus/makina-states/blob/master/services/cloud/lxc-standalone.sls#L57">here</a></p>
<p>
Still impressed by that stuff ? :)<br/>
The terrible news is that cool stuff is on our <a href="https://github.com/makinacorpus/salt">fork</a>.
This in in a review process (but is approved) and will be merged soon to saltcloud/develop branch.
</p>
